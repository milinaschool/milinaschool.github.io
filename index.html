<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>면접 연습 프로그램</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: #f0ede8;
            min-height: 100vh;
            padding: 0;
            color: #1a1a1a;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #faf9f7;
            min-height: 100vh;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.08);
        }

        .header {
            background: #faf9f7;
            border-bottom: 1px solid #d8d4cf;
            padding: 24px 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h1 {
            font-size: 1.5em;
            font-weight: 600;
            color: #1a1a1a;
            letter-spacing: -0.02em;
        }

        .tabs {
            display: flex;
            background: #faf9f7;
            border-bottom: 1px solid #d8d4cf;
            padding: 0 40px;
            gap: 2px;
        }

        .tab {
            padding: 14px 20px;
            text-align: center;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.95em;
            color: #6b7280;
            transition: all 0.2s ease;
            border: none;
            background: transparent;
            border-bottom: 2px solid transparent;
            position: relative;
        }

        .tab:hover {
            color: #374151;
            background: #f0ede8;
        }

        .tab.active {
            color: #c97f66;
            border-bottom-color: #c97f66;
            background: transparent;
        }

        .tab-content {
            display: none;
            padding: 32px 40px;
            background: #faf9f7;
        }

        .tab-content.active {
            display: block;
        }

        /* 연습 탭 스타일 */
        .practice-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }

        .question-section {
            background: #faf9f7;
            padding: 0;
        }

        .category-selector {
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .category-selector label {
            font-weight: 500;
            color: #374151;
            font-size: 0.95em;
        }

        .category-selector select {
            padding: 8px 12px;
            border: 1px solid #d8d4cf;
            border-radius: 6px;
            font-size: 0.95em;
            cursor: pointer;
            background: white;
            color: #1a1a1a;
            transition: border-color 0.2s;
        }

        .category-selector select:focus {
            outline: none;
            border-color: #c97f66;
            box-shadow: 0 0 0 3px rgba(201, 127, 102, 0.1);
        }

        .question-display {
            background: white;
            padding: 24px;
            border-radius: 8px;
            margin: 20px 0;
            min-height: 150px;
            border: 1px solid #e8e5e0;
        }

        .question-number {
            color: #6b7280;
            font-weight: 500;
            font-size: 0.85em;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .question-text {
            font-size: 1.25em;
            color: #1a1a1a;
            line-height: 1.6;
            font-weight: 500;
        }

        .controls {
            display: flex;
            gap: 12px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .btn-primary {
            background: #c97f66;
            color: white;
        }

        .btn-primary:hover {
            background: #b86f58;
        }

        .btn-record {
            background: #a85b47;
            color: white;
            font-size: 1em;
            padding: 12px 24px;
        }

        .btn-record:hover {
            background: #924d3a;
        }

        .btn-record.recording {
            background: #7c9473;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .btn-secondary {
            background: #e8e5e0;
            color: #374151;
            border: 1px solid #d8d4cf;
        }

        .btn-secondary:hover {
            background: #d8d4cf;
        }

        .btn-success {
            background: #7c9473;
            color: white;
        }

        .btn-success:hover {
            background: #6b8064;
        }

        .btn-danger {
            background: #c97f66;
            color: white;
        }

        .btn-danger:hover {
            background: #b86f58;
        }

        .btn-small {
            padding: 6px 14px;
            font-size: 0.875em;
        }
        
        .btn-icon {
             padding: 6px 8px;
             font-size: 0.8em;
             line-height: 1;
        }


        .timer {
            background: #f5e6d3;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 1.5em;
            font-weight: 600;
            color: #8b5a3c;
            text-align: center;
            margin: 20px 0;
            border: 1px solid #e8d5bc;
        }

        .transcription-area {
            background: white;
            border: 1px solid #e8e5e0;
            border-radius: 8px;
            padding: 20px;
            min-height: 150px;
            margin: 20px 0;
        }

        .transcription-area h3 {
            font-size: 0.95em;
            color: #6b7280;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .transcription-text {
            width: 100%;
            min-height: 200px;
            border: 1px solid #e8e5e0;
            border-radius: 6px;
            padding: 12px;
            font-size: 0.95em;
            font-family: inherit;
            resize: vertical;
            background: white;
        }

        .transcription-text:focus {
            outline: none;
            border-color: #c97f66;
            box-shadow: 0 0 0 3px rgba(201, 127, 102, 0.1);
        }

        .history-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e8e5e0;
        }

        .history-panel h2 {
            font-size: 1.1em;
            margin-bottom: 16px;
            color: #1a1a1a;
            font-weight: 600;
        }

        .answer-card {
            background: #faf9f7;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 12px;
            border: 1px solid #e8e5e0;
        }

        .answer-question {
            font-weight: 500;
            color: #1a1a1a;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .answer-meta {
            font-size: 0.85em;
            color: #6b7280;
            margin-bottom: 12px;
        }

        .answer-text {
            color: #374151;
            font-size: 0.9em;
            line-height: 1.6;
            margin-bottom: 12px;
            white-space: pre-wrap;
        }

        .answer-actions {
            display: flex;
            gap: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        /* 질문 관리 스타일 */
        .manager-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .manager-header h2 {
            font-size: 1.5em;
            color: #1a1a1a;
            font-weight: 600;
        }

        .manager-controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .file-input-wrapper input[type="file"] {
            display: none;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e8e5e0;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 600;
            color: #c97f66;
            margin-bottom: 4px;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.9em;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d8d4cf;
            border-radius: 6px;
            font-size: 0.95em;
        }

        .search-box input:focus {
            outline: none;
            border-color: #c97f66;
            box-shadow: 0 0 0 3px rgba(201, 127, 102, 0.1);
        }

        .management-section {
            background: white;
            padding: 24px;
            border-radius: 8px;
            border: 1px solid #e8e5e0;
            margin-bottom: 24px;
        }

        .management-header {
            margin-bottom: 20px;
        }

        .management-header h3 {
            font-size: 1.25em;
            margin-bottom: 8px;
            color: #1a1a1a;
            font-weight: 600;
        }

        .management-header p {
            font-size: 0.9em;
            color: #6b7280;
        }

        #category-list-new {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .category-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: #faf9f7;
            border: 1px solid #e8e5e0;
            border-radius: 6px;
        }

        .category-info-new {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .category-name-badge {
            font-weight: 500;
            padding: 4px 12px;
            background: white;
            border: 1px solid #d8d4cf;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .question-count-badge {
            font-size: 0.9em;
            color: #6b7280;
        }

        .accordion-item {
            border: 1px solid #e8e5e0;
            border-radius: 6px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: #faf9f7;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .accordion-header:hover {
            background: #f0ede8;
        }
        
        .accordion-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            color: #1a1a1a;
            flex: 1;
            overflow: hidden;
        }
        
        .accordion-header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-icon {
            transition: transform 0.3s ease;
            font-size: 0.8em;
        }

        .accordion-header.active .toggle-icon {
            transform: rotate(90deg);
        }

        .accordion-content {
            display: none;
            padding: 16px;
            background: white;
            border-top: 1px solid #e8e5e0;
        }

        .question-list-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0ede8;
        }
        .question-list-item:last-child {
            border-bottom: none;
        }

        .question-number-new {
            color: #6b7280;
            font-size: 0.9em;
            width: 30px;
        }

        .question-text-view {
            flex: 1;
            color: #374151;
        }

        .inline-add-form {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px dashed #d8d4cf;
        }

        .inline-add-form input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d8d4cf;
            border-radius: 6px;
            font-size: 0.95em;
        }
        .inline-add-form input:focus {
            outline: none;
            border-color: #c97f66;
            box-shadow: 0 0 0 3px rgba(201, 127, 102, 0.1);
        }
        
        /* 모달 스타일 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            padding: 24px 24px 16px;
            border-bottom: 1px solid #e8e5e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 1.25em;
            font-weight: 600;
            color: #1a1a1a;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .close-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .modal form {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d8d4cf;
            border-radius: 6px;
            font-size: 0.95em;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #c97f66;
            box-shadow: 0 0 0 3px rgba(201, 127, 102, 0.1);
        }

        .status-message {
            padding: 12px 16px;
            border-radius: 6px;
            margin: 15px 0;
            font-weight: 500;
            font-size: 0.95em;
        }

        .status-info {
            background: #e8f0f5;
            color: #2c5f7a;
            border: 1px solid #c5dae8;
        }

        .status-success {
            background: #e8f2e5;
            color: #4a6b42;
            border: 1px solid #c5ddc0;
        }

        .status-error {
            background: #f5e6e0;
            color: #8b5a3c;
            border: 1px solid #e8d5bc;
        }

        .warning-box {
            background: #fef3c7;
            border: 1px solid #fde68a;
            padding: 16px;
            border-radius: 6px;
            margin: 20px 40px 0;
            color: #92400e;
            font-size: 0.9em;
        }
        .warning-box code {
            background: #fff;
            padding: 2px 8px;
            border-radius: 4px;
            color: #333;
        }

        @media (max-width: 768px) {
            .practice-layout {
                grid-template-columns: 1fr;
            }

            .tabs {
                overflow-x: auto;
                padding: 0 20px;
            }

            .tab {
                white-space: nowrap;
            }

            .manager-header {
                flex-direction: column;
                align-items: stretch;
            }

            .manager-controls {
                width: 100%;
            }

            .manager-controls button {
                flex: 1;
            }
        }
        
        /* 집중 모드 스타일 */
        #focusModeContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            color: white;
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            padding: 40px;
        }

        #focusModeContainer.active {
            display: flex;
            opacity: 1;
        }

        .focus-controls-top {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 12px;
        }

        #focusCategorySelect, #exitFocusBtn {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
        }

        #focus-question-text {
            font-size: 2em;
            font-weight: 500;
            max-width: 800px;
            margin-bottom: 40px;
            min-height: 100px;
        }

        #focus-circle {
            width: 150px;
            height: 150px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s ease-out, background-color 0.3s ease, border 0.3s ease;
            box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4);
        }

        #focus-circle:hover {
            transform: scale(1.05);
        }

        #focus-circle.waiting {
            animation: pulse-white 2s infinite;
        }

        #focus-circle.listening {
            background-color: #ffcdd2; /* 붉은색으로 변경 */
            border: 2px solid #e57373;   /* 테두리 추가 */
        }

        @keyframes pulse-white {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(255, 255, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }

        #focus-status-text {
            margin-top: 30px;
            font-size: 1.1em;
            color: #aaa;
            height: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📝 면접 연습 프로그램</h1>
        </div>
        
        <div id="setupWarning" class="warning-box" style="display: none;">
            <strong>⚠️ 음성 인식을 사용하려면 로컬 서버 또는 HTTPS가 필요합니다!</strong><br>
            현재 <code>file://</code> 프로토콜로 실행 중이어서 음성 인식이 작동하지 않습니다.<br>
            <em>※ 음성 인식 없이 텍스트만 입력해서 사용하셔도 됩니다.</em>
        </div>

        <div style="padding: 12px 40px; margin: 0; display: none;" id="recognitionStatusBar">
            <div style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; border-radius: 6px; border-left: 4px solid;">
                <span id="recognitionStatusIcon" style="font-size: 1.2em;"></span>
                <span id="recognitionStatusText" style="font-weight: 500;"></span>
            </div>
        </div>


        <div class="tabs">
            <button class="tab active" onclick="switchTab('practice')">연습</button>
            <button class="tab" onclick="switchTab('questions')">질문 데이터베이스</button>
            <button class="tab" onclick="switchTab('answers')">답변 기록</button>
            <button class="tab" onclick="switchTab('stats')">통계</button>
        </div>

        <!-- 연습 탭 -->
        <div id="practice-tab" class="tab-content active">
            <div class="practice-layout">
                <div class="question-section">
                    <div class="category-selector">
                        <label>카테고리:</label>
                        <select id="categorySelect">
                            <option value="all">전체</option>
                        </select>
                    </div>

                    <div class="question-display" id="questionDisplay">
                        <div class="question-number">질문을 선택해주세요</div>
                        <div class="question-text">"새 질문" 버튼을 클릭하여 시작하세요</div>
                    </div>

                    <div class="controls">
                        <button class="btn-primary" onclick="getNewQuestion()">새 질문</button>
                        <button class="btn-record" id="recordBtn" onclick="toggleRecording()">녹음 시작</button>
                        <button class="btn-secondary" onclick="resetTimer()">타이머 리셋</button>
                    </div>

                    <div class="timer" id="timer">00:00</div>

                    <div class="transcription-area">
                        <h3>답변 내용 (수정 가능)</h3>
                        <textarea class="transcription-text" id="transcriptionText" placeholder="녹음을 시작하면 여기에 텍스트가 표시됩니다..."></textarea>
                    </div>

                    <div class="controls">
                        <button class="btn-success" onclick="saveAnswer()">답변 저장</button>
                        <button class="btn-secondary" onclick="clearTranscription()">내용 지우기</button>
                    </div>

                    <div id="statusMessage"></div>
                </div>

                <div class="history-panel">
                    <h2>최근 답변 (5개)</h2>
                    <div id="recentAnswers"></div>
                </div>
            </div>
        </div>

        <!-- 질문 관리 탭 -->
        <div id="questions-tab" class="tab-content">
            <div class="manager-header">
                <h2>전체 데이터베이스 관리</h2>
                <div class="manager-controls">
                    <button class="btn-secondary" onclick="exportDatabase()">DB 내보내기</button>
                    <div class="file-input-wrapper">
                        <input type="file" id="dbImportFile" accept=".json" onchange="importDatabase(event)">
                        <button class="btn-secondary" onclick="document.getElementById('dbImportFile').click()">DB 가져오기</button>
                    </div>
                </div>
            </div>
            
            <div class="management-section">
                <div class="management-header">
                    <h3>📂 카테고리 관리</h3>
                    <p>모든 데이터는 브라우저에 자동으로 저장됩니다. 카테고리를 추가, 수정, 삭제하여 질문을 체계적으로 관리하세요.</p>
                </div>
                <div id="category-list-new">
                    <!-- 자바스크립트로 카테고리 목록이 생성됩니다. -->
                </div>
                <button class="btn-primary" onclick="openAddCategoryModal()">+ 새 카테고리 추가</button>
            </div>

            <div class="management-section">
                <div class="management-header">
                    <h3>📚 질문 관리</h3>
                    <p>각 카테고리를 클릭하여 펼치거나 접을 수 있습니다. 카테고리별로 질문 데이터를 내보내거나 가져올 수 있습니다.</p>
                </div>
                <div id="question-accordion-list">
                    <!-- 자바스크립트로 아코디언 목록이 생성됩니다. -->
                </div>
            </div>
        </div>

        <!-- 답변 관리 탭 -->
        <div id="answers-tab" class="tab-content">
            <div class="answer-manager">
                <div class="manager-header">
                    <h2>답변 기록 관리</h2>
                    <div class="manager-controls">
                        <button class="btn-primary" onclick="exportAnswers()">답변 내보내기</button>
                        <div class="file-input-wrapper">
                            <input type="file" id="answerImportFile" accept=".json" onchange="importAnswers(event)">
                            <button class="btn-secondary" onclick="document.getElementById('answerImportFile').click()">답변 가져오기</button>
                        </div>
                        <button class="btn-danger" onclick="clearAllAnswers()">전체 삭제</button>
                    </div>
                </div>

                <div class="search-box">
                    <input type="text" id="answerSearch" placeholder="답변 검색..." oninput="filterAnswers()">
                </div>

                <div id="answerList"></div>
            </div>
        </div>

        <!-- 통계 탭 -->
        <div id="stats-tab" class="tab-content">
            <h2 style="margin-bottom: 24px; font-size: 1.5em;">📊 연습 통계</h2>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="statsQuestionsCount">0</div>
                    <div class="stat-label">전체 질문 수</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statsCategoryCount">0</div>
                    <div class="stat-label">카테고리 수</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statsAnswersCount">0</div>
                    <div class="stat-label">저장된 답변</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statsPracticeTime">0</div>
                    <div class="stat-label">총 연습 시간 (분)</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 질문 추가/편집 모달 -->
    <div id="questionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">질문 추가</h3>
                <button class="close-btn" onclick="closeQuestionModal()">×</button>
            </div>
            <form id="questionForm" onsubmit="saveQuestion(event)">
                <div class="form-group">
                    <label>카테고리*</label>
                    <select id="questionCategory" required>
                    </select>
                </div>
                <div class="form-group">
                    <label>질문 내용*</label>
                    <textarea id="questionText" required placeholder="질문을 입력하세요..."></textarea>
                </div>
                <input type="hidden" id="questionId">
                <div class="controls">
                    <button type="submit" class="btn-success">저장</button>
                    <button type="button" class="btn-secondary" onclick="closeQuestionModal()">취소</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 카테고리 추가/편집 모달 -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="categoryModalTitle">카테고리 추가</h3>
                <button class="close-btn" onclick="closeCategoryModal()">×</button>
            </div>
            <form id="categoryForm" onsubmit="saveCategory(event)">
                <div class="form-group">
                    <label>카테고리 ID* (영문, 숫자, 언더스코어만 가능)</label>
                    <input type="text" id="categoryId" required pattern="[a-zA-Z0-9_]+" placeholder="예: personality">
                </div>
                <div class="form-group">
                    <label>카테고리 이름*</label>
                    <input type="text" id="categoryName" required placeholder="예: 인성/가치관">
                </div>
                <input type="hidden" id="editingCategoryId">
                <div class="controls">
                    <button type="submit" class="btn-success">저장</button>
                    <button type="button" class="btn-secondary" onclick="closeCategoryModal()">취소</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 집중 모드 컨테이너 -->
    <div id="focusModeContainer">
        <div class="focus-controls-top">
            <select id="focusCategorySelect"></select>
            <button id="exitFocusBtn">나가기</button>
        </div>
        <div id="focus-question-text">
            집중 모드를 시작하려면 중앙의 원을 클릭하세요.
        </div>
        <div id="focus-circle"></div>
        <div id="focus-status-text"></div>
    </div>

<script>
    const defaultData = {
        categories: {
            basic: "기본 질문",
            academic: "학업/탐구",
            personality: "인성/가치관",
            department: "학과/진로",
            technical: "전공 관련"
        },
        questions: {
            basic: [
                "간단하게 자기소개를 해주세요.",
                "자신의 장점을 구체적인 사례와 함께 말씀해주세요.",
                "자신의 단점은 무엇이고, 이를 극복하기 위해 어떤 노력을 하고 있나요?",
                "본 대학교, 본 학과에 지원한 동기는 무엇인가요?",
                "마지막으로 하고 싶은 말씀이 있으신가요?",
            ],
            academic: [
                "고등학교에서 가장 열심히 공부한 과목과 그 이유는 무엇인가요?",
                "학생부에서 가장 인상 깊은 탐구활동을 소개해주세요.",
                "탐구활동을 하면서 가장 어려웠던 점과 극복 과정을 설명해주세요.",
                "학업 성적이 낮은 과목이 있다면 그 이유와 개선 노력을 말씀해주세요.",
                "고교 3년간 가장 의미 있었던 활동(성취)은 무엇인가요? 그 이유는 무엇인가요?",
                "자신만의 학습 방법이나 시간 관리 노하우가 있나요?"
            ],
            personality: [
                "리더십을 발휘한 경험이 있나요? 구체적으로 설명해주세요.",
                "팀 프로젝트에서 리더 역할을 맡았던 경험을 구체적으로 설명해주세요.",
                "리더십과 팔로워십 중 자신은 어느 쪽에 더 가까운가요?",
                "갈등 상황에서 어떻게 대처하나요? 구체적인 사례를 들어 설명해주세요.",
                "타인과 의견이 다를 때 어떻게 조율하나요?",
                "모둠 활동에 제대로 참여하지 않는 친구가 있다면 어떻게 할건가요?",
                "친구가 어려움에 처했을 때 도와준 경험이 있나요?",
                "실패한 경험과 그로부터 배운 점을 말씀해주세요.",
                "지금까지 살아오면서 겪었던 가장 힘들었던 경험은 무엇이고 어떻게 극복했나요?",
                "스트레스를 받을 때 어떻게 해소하나요?",
                "새로운 환경에 적응하는 자신만의 방법이 있나요?",
                "최근에 읽은 책 중 가장 인상 깊었던 책과 그 이유를 말씀해주세요.",
                "존경하는 인물이 있다면 누구이며, 그 이유는 무엇인가요?",
                "봉사활동 중 가장 기억에 남는 활동이 있나요?",
                "가장 중요하게 생각하는 가치관은 무엇인가요?"
            ],
            department: [
                "대학 입학 후 가장 먼저 하고 싶은 일은 무엇인가요?",
                "입학 후 학업계획을 말해주세요.",
                "10년 후 자신의 모습은 어떨 것 같나요?",
                "졸업 후 진로 계획은 어떻게 되나요?",
                "이 학과에서 가장 듣고 싶은 과목은 무엇인가요?",
                "이 학과에 지원하기 위해 어떤 노력을 했나요?"
            ],
            technical: [],
        }
    };

    // 전역 변수
    let categories = {};
    let questions = {};
    let answers = [];
    let currentQuestion = null;
    let isRecording = false;
    let recognition = null;
    let timerInterval = null;
    let seconds = 0;
    let editingQuestionId = null;
    let koreanVoice = null; // TTS 목소리 저장 변수

    // 집중 모드 관련 전역 변수
    let isInFocusMode = false;
    let focusState = 'idle'; // idle -> waiting -> listening -> processing
    const FOCUS_DELAY = 500;

    // 초기화
    function init() {
        loadKoreanVoice(); // 자연스러운 한국어 목소리 로드
        loadDataFromStorage();
        updateAllUIs();
        updateAnswerList();
        initSpeechRecognition();
        createFocusModeButton();
    }

    function createFocusModeButton() {
        const focusModeBtn = document.createElement('button');
        focusModeBtn.className = 'btn-secondary';
        focusModeBtn.textContent = '집중 모드';
        focusModeBtn.onclick = enterFocusMode;
        document.querySelector('.header').appendChild(focusModeBtn);
    }
    
    function loadKoreanVoice() {
        const setVoice = () => {
            const voices = window.speechSynthesis.getVoices();
            koreanVoice = voices.find(voice => voice.lang === 'ko-KR' && voice.name.includes('Online')) || 
                          voices.find(voice => voice.lang === 'ko-KR');
        };
        if (window.speechSynthesis.onvoiceschanged !== undefined) {
            window.speechSynthesis.onvoiceschanged = setVoice;
        }
        setVoice();
    }

    // --- 데이터 관리 ---
    function loadDataFromStorage() {
        const storedCategories = localStorage.getItem('interviewCategories');
        const storedQuestions = localStorage.getItem('interviewQuestions');
        const storedAnswers = localStorage.getItem('interviewAnswers');

        categories = storedCategories ? JSON.parse(storedCategories) : JSON.parse(JSON.stringify(defaultData.categories));
        questions = storedQuestions ? JSON.parse(storedQuestions) : JSON.parse(JSON.stringify(defaultData.questions));
        answers = storedAnswers ? JSON.parse(storedAnswers) : [];

        if (!storedCategories && !storedQuestions) {
            saveCategoriesToStorage();
            saveQuestionsToStorage();
        }
    }

    function saveCategoriesToStorage() { localStorage.setItem('interviewCategories', JSON.stringify(categories)); }
    function saveQuestionsToStorage() { localStorage.setItem('interviewQuestions', JSON.stringify(questions)); }
    function saveAnswersToStorage() { localStorage.setItem('interviewAnswers', JSON.stringify(answers)); }

    // --- UI 렌더링 ---
    function updateAllUIs() {
        renderCategoryManagement();
        renderQuestionAccordion();
        updateCategorySelectors();
        updateRecentAnswers();
        updateStats();
    }

    function renderCategoryManagement() {
        const container = document.getElementById('category-list-new');
        if (!container) return;
        
        container.innerHTML = Object.entries(categories).map(([id, name]) => `
            <div class="category-list-item">
                <div class="category-info-new">
                    <span class="category-name-badge">${id}</span>
                    <span>${name}</span>
                    <span class="question-count-badge">${(questions[id] || []).length}개 질문</span>
                </div>
                <div class="answer-actions">
                    <button class="btn-secondary btn-small" onclick='editCategory("${id}")'>수정</button>
                    <button class="btn-danger btn-small" onclick='deleteCategory("${id}")'>삭제</button>
                </div>
            </div>
        `).join('');
    }

    function renderQuestionAccordion() {
        const container = document.getElementById('question-accordion-list');
        if (!container) return;

        container.innerHTML = Object.entries(categories).map(([id, name]) => {
            const questionList = questions[id] || [];
            const questionsHtml = questionList.map((q, index) => `
                <div class="question-list-item">
                    <span class="question-number-new">${index + 1}.</span>
                    <span class="question-text-view">${q}</span>
                    <div class="answer-actions">
                        <button class="btn-secondary btn-small btn-icon" onclick='editQuestion("${id}", ${index})' title="수정">✏️</button>
                        <button class="btn-danger btn-small btn-icon" onclick='deleteQuestion("${id}", ${index})' title="삭제">🗑️</button>
                    </div>
                </div>
            `).join('');

            return `
                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggleAccordion(this)" data-category-id="${id}">
                        <div class="accordion-header-left">
                            <span class="toggle-icon">▶</span>
                            <span>${name}</span>
                            <span class="question-count-badge">${questionList.length}개</span>
                        </div>
                        <div class="accordion-header-right">
                             <button class="btn-secondary btn-small" onclick="event.stopPropagation(); exportCategory('${id}');">내보내기</button>
                             <button class="btn-secondary btn-small" onclick="event.stopPropagation(); triggerCategoryImport('${id}');">가져오기</button>
                             <button class="btn-primary btn-small" onclick="event.stopPropagation(); openAddQuestionModal('${id}');">+</button>
                        </div>
                    </div>
                    <div class="accordion-content" id="content-${id}">
                        ${questionsHtml.length > 0 ? questionsHtml : '<p style="color: #6b7280; text-align: center; padding: 10px 0;">질문이 없습니다.</p>'}
                        <form class="inline-add-form" onsubmit="inlineAddQuestion(event, '${id}')">
                            <input type="text" placeholder="새 질문을 입력하고 Enter를 누르세요..." required>
                        </form>
                    </div>
                </div>
            `;
        }).join('');
    }

    function toggleAccordion(headerElement) {
        headerElement.classList.toggle('active');
        const content = headerElement.nextElementSibling;
        content.style.display = content.style.display === "block" ? "none" : "block";
    }

    function inlineAddQuestion(event, categoryId) {
        event.preventDefault();
        const input = event.target.querySelector('input');
        const newQuestion = input.value.trim();
        if (newQuestion) {
            if (!questions[categoryId]) questions[categoryId] = [];
            questions[categoryId].push(newQuestion);
            saveQuestionsToStorage();
            updateAllUIs();
            input.value = '';
            const header = document.querySelector(`.accordion-header[data-category-id="${categoryId}"]`);
            if (header && !header.classList.contains('active')) toggleAccordion(header);
        }
    }

    // --- 카테고리 관리 ---
    function openAddCategoryModal() {
        document.getElementById('categoryModalTitle').textContent = '카테고리 추가';
        document.getElementById('categoryForm').reset();
        document.getElementById('categoryId').disabled = false;
        document.getElementById('editingCategoryId').value = '';
        document.getElementById('categoryModal').classList.add('active');
    }

    function editCategory(categoryId) {
        document.getElementById('categoryModalTitle').textContent = '카테고리 편집';
        document.getElementById('categoryForm').reset();
        document.getElementById('categoryId').value = categoryId;
        document.getElementById('categoryId').disabled = true;
        document.getElementById('categoryName').value = categories[categoryId];
        document.getElementById('editingCategoryId').value = categoryId;
        document.getElementById('categoryModal').classList.add('active');
    }

    function closeCategoryModal() { document.getElementById('categoryModal').classList.remove('active'); }

    function saveCategory(event) {
        event.preventDefault();
        const categoryId = document.getElementById('categoryId').value.trim();
        const categoryName = document.getElementById('categoryName').value.trim();
        const oldCategoryId = document.getElementById('editingCategoryId').value;

        if (!categoryId || !categoryName) return;
        if (!oldCategoryId && categories[categoryId]) {
            alert('이미 존재하는 카테고리 ID입니다.');
            return;
        }

        if (oldCategoryId) categories[oldCategoryId] = categoryName;
        else {
            categories[categoryId] = categoryName;
            if (!questions[categoryId]) questions[categoryId] = [];
        }
        saveCategoriesToStorage();
        saveQuestionsToStorage();
        updateAllUIs();
        closeCategoryModal();
    }

    function deleteCategory(categoryId) {
        const questionCount = (questions[categoryId] || []).length;
        const confirmMsg = questionCount > 0
            ? `이 카테고리에는 ${questionCount}개의 질문이 있습니다. 카테고리와 함께 모든 질문을 삭제하시겠습니까?`
            : `'${categories[categoryId]}' 카테고리를 삭제하시겠습니까?`;
        if (confirm(confirmMsg)) {
            delete categories[categoryId];
            delete questions[categoryId];
            saveCategoriesToStorage();
            saveQuestionsToStorage();
            updateAllUIs();
        }
    }
    
    // --- 질문 관리 ---
    function openAddQuestionModal(categoryId = null) {
        editingQuestionId = null;
        document.getElementById('modalTitle').textContent = '질문 추가';
        document.getElementById('questionForm').reset();
        document.getElementById('questionId').value = '';
        document.getElementById('questionCategory').value = categoryId || Object.keys(categories)[0] || '';
        document.getElementById('questionModal').classList.add('active');
    }

    function editQuestion(categoryId, index) {
        editingQuestionId = `${categoryId}-${index}`;
        document.getElementById('modalTitle').textContent = '질문 편집';
        document.getElementById('questionForm').reset();
        document.getElementById('questionCategory').value = categoryId;
        document.getElementById('questionText').value = questions[categoryId][index];
        document.getElementById('questionId').value = editingQuestionId;
        document.getElementById('questionModal').classList.add('active');
    }

    function closeQuestionModal() { document.getElementById('questionModal').classList.remove('active'); }

    function saveQuestion(event) {
        event.preventDefault();
        const categoryId = document.getElementById('questionCategory').value;
        const text = document.getElementById('questionText').value.trim();
        const questionId = document.getElementById('questionId').value;

        if (!text) return;
        if (!questions[categoryId]) questions[categoryId] = [];

        if (questionId) {
            const [oldCategoryId, index] = questionId.split('-');
            if (oldCategoryId === categoryId) questions[oldCategoryId][parseInt(index)] = text;
            else {
                questions[oldCategoryId].splice(parseInt(index), 1);
                questions[categoryId].push(text);
            }
        } else {
            questions[categoryId].push(text);
        }
        saveQuestionsToStorage();
        updateAllUIs();
        closeQuestionModal();
    }

    function deleteQuestion(categoryId, index) {
        questions[categoryId].splice(index, 1);
        saveQuestionsToStorage();
        updateAllUIs();
    }

    // --- 데이터 관리 (전체/카테고리별) ---
    function exportDatabase() {
        const data = { categories, questions };
        const dataStr = JSON.stringify(data, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `interview_db_all_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function importDatabase(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (data.categories && data.questions) {
                    if (confirm('가져온 데이터로 기존 질문 데이터베이스를 완전히 덮어쓰시겠습니까?')) {
                        categories = data.categories;
                        questions = data.questions;
                        saveCategoriesToStorage();
                        saveQuestionsToStorage();
                        updateAllUIs();
                        alert('데이터베이스를 성공적으로 가져왔습니다.');
                    }
                } else { alert('올바른 형식의 데이터베이스 파일이 아닙니다.'); }
            } catch (error) { alert('파일을 읽는 중 오류가 발생했습니다.'); }
        };
        reader.readAsText(file);
        event.target.value = '';
    }
    
    function exportCategory(categoryId) {
        const categoryQuestions = questions[categoryId] || [];
        const dataStr = JSON.stringify(categoryQuestions, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `questions_${categoryId}_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function triggerCategoryImport(categoryId) {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = (event) => importCategory(event, categoryId);
        input.click();
    }

    function importCategory(event, categoryId) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedQuestions = JSON.parse(e.target.result);
                if (Array.isArray(importedQuestions)) {
                    if (!questions[categoryId]) questions[categoryId] = [];
                    const originalCount = questions[categoryId].length;
                    questions[categoryId] = [...new Set([...questions[categoryId], ...importedQuestions])];
                    const addedCount = questions[categoryId].length - originalCount;
                    saveQuestionsToStorage();
                    updateAllUIs();
                    alert(`'${categories[categoryId]}' 카테고리에 ${addedCount}개의 새 질문을 가져왔습니다.`);
                } else { alert('올바른 형식의 질문 파일(질문 목록 배열)이 아닙니다.'); }
            } catch (error) { alert('파일을 읽는 중 오류가 발생했습니다.'); }
        };
        reader.readAsText(file);
    }

    // --- 음성 인식 (고급 버전) ---
    function initSpeechRecognition() {
        if (window.location.protocol === 'file:') {
            document.getElementById('setupWarning').style.display = 'block';
            return;
        }
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            try {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'ko-KR';
                recognition.maxAlternatives = 1;
                let finalTranscript = '';

                recognition.onstart = () => {
                    finalTranscript = document.getElementById('transcriptionText').value;
                     if (finalTranscript.length > 0 && !finalTranscript.endsWith(' ')) finalTranscript += ' ';
                    showRecognitionStatus('음성 인식 활성화 - 말씀해주세요', '#7c9473', '●');
                };

                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    document.getElementById('transcriptionText').value = finalTranscript + interimTranscript;
                    if (interimTranscript) showRecognitionStatus(`🔊 인식 중...`, '#3b82f6', '●');
                };

                recognition.onerror = (event) => {
                    let errorMsg = '음성 인식 오류';
                    switch(event.error) {
                        case 'network': errorMsg = '네트워크 오류. 인터넷 연결을 확인하세요.'; break;
                        case 'not-allowed': errorMsg = '마이크 권한이 거부되었습니다. 권한을 허용해주세요.'; break;
                        case 'no-speech': errorMsg = '음성이 감지되지 않았습니다. 다시 시도해주세요.'; break;
                        case 'audio-capture': errorMsg = '마이크를 찾을 수 없습니다.'; break;
                    }
                    showStatus(errorMsg, 'error');
                    showRecognitionStatus(errorMsg, '#ef4444', '!');
                    stopRecording();
                };

                recognition.onend = () => {
                    if (isRecording) {
                        try { recognition.start(); }
                        catch (e) { stopRecording(); showRecognitionStatus('⚠️ 재시작 실패', '#ef4444', '!'); }
                    } else {
                        showRecognitionStatus('음성 인식 대기 중', '#6b7280', '○');
                    }
                };
                showRecognitionStatus('음성 인식 준비 완료', '#10b981', '✓');
            } catch (e) {
                showStatus('음성 인식을 초기화할 수 없습니다.', 'error');
                showRecognitionStatus('❌ 초기화 실패', '#ef4444', '!');
            }
        } else {
            showStatus('이 브라우저는 음성 인식을 지원하지 않습니다.', 'error');
            showRecognitionStatus('❌ 브라우저 미지원', '#ef4444', '!');
        }
    }

    function showRecognitionStatus(message, color, icon) {
        const statusBar = document.getElementById('recognitionStatusBar');
        const statusText = document.getElementById('recognitionStatusText');
        const statusIcon = document.getElementById('recognitionStatusIcon');
        
        if (statusBar) {
            statusBar.style.display = 'block';
            const wrapper = statusBar.querySelector('div');
            wrapper.style.backgroundColor = color + '20';
            wrapper.style.borderColor = color;
            statusText.textContent = message;
            statusText.style.color = color;
            statusIcon.textContent = icon;
            statusIcon.style.color = color;
        }
    }

    function toggleRecording() {
        if (!recognition) {
            showStatus('음성 인식을 사용할 수 없습니다.', 'error');
            return;
        }
        if (!currentQuestion) {
            showStatus('먼저 질문을 선택해주세요.', 'error');
            return;
        }
        if (isRecording) stopRecording();
        else startRecording();
    }

    function startRecording() {
        try {
            recognition.start();
            isRecording = true;
            if (!isInFocusMode) {
                document.getElementById('recordBtn').textContent = '녹음 중지';
                document.getElementById('recordBtn').classList.add('recording');
                startTimer();
                showStatus('녹음 중... 답변을 시작하세요.', 'info');
            }
        } catch (e) {
            showStatus('녹음을 시작할 수 없습니다. 텍스트로 직접 입력해주세요.', 'error');
            isRecording = false;
        }
    }

    function stopRecording() {
        if (recognition && isRecording) {
            isRecording = false;
            recognition.stop();
        } else {
            isRecording = false;
        }
        if (!isInFocusMode) {
            document.getElementById('recordBtn').textContent = '녹음 시작';
            document.getElementById('recordBtn').classList.remove('recording');
            stopTimer();
            if (document.getElementById('transcriptionText').value.trim()) {
                showStatus('녹음이 중지되었습니다. 답변을 확인하고 저장하세요.', 'success');
            }
        }
    }

    // --- 기타 유틸리티 함수 ---
    function switchTab(tabName) {
        document.querySelectorAll('.tab.active, .tab-content.active').forEach(el => el.classList.remove('active'));
        const clickedTab = Array.from(document.querySelectorAll('.tab')).find(tab => tab.getAttribute('onclick').includes(`'${tabName}'`));
        if(clickedTab) clickedTab.classList.add('active');
        document.getElementById(tabName + '-tab').classList.add('active');
        if (tabName === 'answers') updateAnswerList();
        updateAllUIs();
    }
    
    function updateCategorySelectors() {
        const selectors = [document.getElementById('categorySelect'), document.getElementById('questionCategory')];
        const categoryOptions = Object.entries(categories).map(([id, name]) => `<option value="${id}">${name}</option>`).join('');
        selectors.forEach(selector => {
            if (selector) {
                const currentVal = selector.value;
                selector.innerHTML = selector.id === 'categorySelect' ? '<option value="all">전체</option>' + categoryOptions : categoryOptions;
                selector.value = currentVal;
            }
        });
    }

    function startTimer() {
        if (timerInterval) return;
        timerInterval = setInterval(() => {
            seconds++;
            updateTimerDisplay();
        }, 1000);
    }

    function stopTimer() {
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = null;
    }

    function resetTimer() {
        stopTimer();
        seconds = 0;
        updateTimerDisplay();
    }

    function updateTimerDisplay() {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        document.getElementById('timer').textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    function getNewQuestion() {
        const category = document.getElementById('categorySelect').value;
        const availableQuestions = category === 'all' ? Object.values(questions).flat() : questions[category] || [];
        if (availableQuestions.length === 0) {
            showStatus('선택한 카테고리에 질문이 없습니다.', 'error');
            currentQuestion = null;
            document.getElementById('questionDisplay').innerHTML = `<div class="question-number">질문 없음</div><div class="question-text">선택한 카테고리에 질문이 없습니다.</div>`;
            return;
        }
        currentQuestion = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
        document.getElementById('questionDisplay').innerHTML = `<div class="question-number">질문 (${getQuestionCategory(currentQuestion, true)})</div><div class="question-text">${currentQuestion}</div>`;
        resetTimer();
        clearTranscription();
    }

    function getQuestionCategory(question, returnName = false) {
        for (const [categoryId, questionList] of Object.entries(questions)) {
            if (questionList.includes(question)) return returnName ? (categories[categoryId] || categoryId) : categoryId;
        }
        return returnName ? '기타' : 'unknown';
    }

    function saveAnswer() {
        const transcription = document.getElementById('transcriptionText').value.trim();
        if (!currentQuestion) {
            if (!isInFocusMode) showStatus('질문을 먼저 선택해주세요.', 'error');
            return;
        }
        if (!transcription) {
            if (!isInFocusMode) showStatus('답변 내용이 비어있습니다.', 'error');
            return;
        }
        const answer = {
            id: Date.now(),
            question: currentQuestion,
            answer: transcription,
            duration: seconds,
            timestamp: new Date().toISOString(),
            category: getQuestionCategory(currentQuestion, true)
        };
        answers.unshift(answer);
        saveAnswersToStorage();
        updateAllUIs();
        if (!isInFocusMode) {
            showStatus('답변이 저장되었습니다!', 'success');
        }
        clearTranscription();
        resetTimer();
    }

    function clearTranscription() { document.getElementById('transcriptionText').value = ''; }

    function updateRecentAnswers() {
        const container = document.getElementById('recentAnswers');
        const recent = answers.slice(0, 5);
        if (recent.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>아직 저장된 답변이 없습니다.</p></div>';
            return;
        }
        container.innerHTML = recent.map(answer => `
            <div class="answer-card">
                <div class="answer-question">${answer.question}</div>
                <div class="answer-meta">${answer.category} | ${Math.floor(answer.duration / 60)}분 ${answer.duration % 60}초</div>
            </div>
        `).join('');
    }

    function updateAnswerList() {
        const container = document.getElementById('answerList');
        const searchTerm = document.getElementById('answerSearch')?.value.toLowerCase() || '';
        const filtered = answers.filter(a => !searchTerm || a.question.toLowerCase().includes(searchTerm) || a.answer.toLowerCase().includes(searchTerm));
        if (filtered.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>저장된 답변이 없습니다.</p></div>';
            return;
        }
        container.innerHTML = filtered.map(answer => `
            <div class="answer-card">
                <div class="answer-question">${answer.question}</div>
                <div class="answer-meta">카테고리: ${answer.category} | 시간: ${Math.floor(answer.duration / 60)}분 ${answer.duration % 60}초 | ${new Date(answer.timestamp).toLocaleString('ko-KR')}</div>
                <div class="answer-text">${answer.answer.replace(/\n/g, '<br>')}</div>
                <div class="answer-actions"><button class="btn-danger btn-small" onclick="deleteAnswer(${answer.id})">삭제</button></div>
            </div>
        `).join('');
    }

    function filterAnswers() { updateAnswerList(); }

    function deleteAnswer(id) {
        if (confirm('이 답변을 삭제하시겠습니까?')) {
            answers = answers.filter(a => a.id !== id);
            saveAnswersToStorage();
            updateAnswerList();
            updateAllUIs();
            showStatus('답변이 삭제되었습니다.', 'info');
        }
    }

    function clearAllAnswers() {
        if (answers.length > 0 && confirm('모든 답변 기록을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
            answers = [];
            saveAnswersToStorage();
            updateAnswerList();
            updateAllUIs();
            showStatus('모든 답변이 삭제되었습니다.', 'info');
        }
    }

    function exportAnswers() {
        if (answers.length === 0) {
            showStatus('내보낼 답변이 없습니다.', 'error');
            return;
        }
        const dataStr = JSON.stringify(answers, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `interview-answers-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function importAnswers(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const imported = JSON.parse(e.target.result);
                if (!Array.isArray(imported)) throw new Error("Invalid format");
                if (confirm('기존 답변을 덮어쓰시겠습니까? (취소하면 기존 답변에 추가됩니다)')) answers = imported;
                else answers = [...answers, ...imported];
                saveAnswersToStorage();
                updateAnswerList();
                updateAllUIs();
                showStatus(`${imported.length}개의 답변을 가져왔습니다.`, 'success');
            } catch (error) { showStatus('파일을 읽는 중 오류가 발생했습니다.', 'error'); }
        };
        reader.readAsText(file);
        event.target.value = '';
    }

    function updateStats() {
        const totalQuestions = Object.values(questions).reduce((sum, list) => sum + list.length, 0);
        const categoryCount = Object.keys(categories).length;
        const totalAnswers = answers.length;
        const totalTime = answers.reduce((sum, a) => sum + a.duration, 0);
        const stats = {
            statsQuestionsCount: totalQuestions,
            statsCategoryCount: categoryCount,
            statsAnswersCount: totalAnswers,
            statsPracticeTime: Math.round(totalTime / 60),
        };
        for (const [id, value] of Object.entries(stats)) {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        }
    }

    function showStatus(message, type) {
        const statusDiv = document.getElementById('statusMessage');
        statusDiv.className = `status-message status-${type}`;
        statusDiv.textContent = message;
        setTimeout(() => {
            statusDiv.textContent = '';
            statusDiv.className = '';
        }, 5000);
    }

    // --- 집중 모드 관련 함수들 ---
    function enterFocusMode() {
        const container = document.getElementById('focusModeContainer');
        container.classList.add('active');
        isInFocusMode = true;

        const mainCategorySelect = document.getElementById('categorySelect');
        const focusCategorySelect = document.getElementById('focusCategorySelect');
        focusCategorySelect.innerHTML = mainCategorySelect.innerHTML;
        focusCategorySelect.value = mainCategorySelect.value;
        
        resetFocusMode();
        clearTranscription();
    }

    function exitFocusMode() {
        if (isRecording) stopRecording();
        const container = document.getElementById('focusModeContainer');
        container.classList.remove('active');
        isInFocusMode = false;
        resetFocusMode();
    }
    document.getElementById('exitFocusBtn').addEventListener('click', exitFocusMode);

    function resetFocusMode() {
        focusState = 'idle';
        document.getElementById('focus-question-text').textContent = '집중 모드를 시작하려면 중앙의 원을 클릭하세요.';
        document.getElementById('focus-status-text').textContent = '';
        const circle = document.getElementById('focus-circle');
        circle.classList.remove('waiting', 'listening');
    }

    function speak(text, callback) {
        if (!('speechSynthesis' in window)) {
            alert('이 브라우저는 음성 합성을 지원하지 않습니다.');
            if (callback) callback();
            return;
        }
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        if (koreanVoice) {
            utterance.voice = koreanVoice;
        }
        utterance.lang = 'ko-KR';
        utterance.rate = 1.0;
        utterance.onend = () => {
            if (callback) callback();
        };
        window.speechSynthesis.speak(utterance);
    }

    function startFocusModeQuestion() {
        if (focusState !== 'idle') return;
        clearTranscription();
        resetTimer();

        const category = document.getElementById('focusCategorySelect').value;
        const availableQuestions = category === 'all' ? Object.values(questions).flat() : questions[category] || [];
        if (availableQuestions.length === 0) {
            document.getElementById('focus-question-text').textContent = '선택한 카테고리에 질문이 없습니다.';
            return;
        }
        currentQuestion = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
        document.getElementById('focus-question-text').textContent = currentQuestion;

        focusState = 'waiting';
        document.getElementById('focus-status-text').textContent = '질문을 들어보세요...';
        
        speak(currentQuestion, () => {
            const circle = document.getElementById('focus-circle');
            circle.classList.add('waiting');
            document.getElementById('focus-status-text').textContent = '답변을 준비하세요...';
            startTimer();

            setTimeout(() => {
                circle.classList.remove('waiting');
                circle.classList.add('listening');
                document.getElementById('focus-status-text').textContent = '듣고 있습니다...';
                startRecording();
                focusState = 'listening';
            }, FOCUS_DELAY);
        });
    }

    function stopAndSaveAnswer() {
        if (focusState !== 'listening') return;
        
        focusState = 'processing';
        document.getElementById('focus-status-text').textContent = '답변을 처리 중입니다...';
        
        stopTimer();
        stopRecording();

        setTimeout(() => {
            saveAnswer();
            document.getElementById('focus-status-text').textContent = '답변이 저장되었습니다. 다시 시작하려면 원을 클릭하세요.';
            focusState = 'idle';
            document.getElementById('focus-circle').classList.remove('listening');
        }, 1000);
    }

    document.getElementById('focus-circle').addEventListener('click', () => {
        if (focusState === 'idle') {
            startFocusModeQuestion();
        } else if (focusState === 'listening') {
            stopAndSaveAnswer();
        }
    });

    document.addEventListener('DOMContentLoaded', init);
    document.querySelectorAll('.modal').forEach(modal => modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('active'); }));
</script>
</body>
</html>
